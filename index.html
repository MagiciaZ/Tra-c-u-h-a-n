<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra c·ª©u h√≥a ƒë∆°n</title>
<style>
body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 30px auto;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #fafafa;
}
h1 {
    text-align: center;
    color: #0066cc;
}
.code {
    font-size: 20px;
    font-weight: bold;
    margin: 20px 0;
    text-align: center;
}
.info {
    margin-top: 20px;
    padding: 15px;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #ccc;
}
.label {
    font-weight: bold;
}
.loading {
    text-align: center;
    color: #666;
}
.error {
    color: #cc0000;
    text-align: center;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
table th, table td {
    border: 1px solid #ddd;
    padding: 10px 8px;
    text-align: left;
}
table th {
    background-color: #e6f2ff;
    font-weight: bold;
    text-align: center;
}
</style>
</head>
<body>
<h1>Tra c·ª©u h√≥a ƒë∆°n nh√† thu·ªëc</h1>
<div id="content">
    <p class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</p>
</div>
<script>
// L·∫•y m√£ h√≥a ƒë∆°n t·ª´ URL: ?code=HD202511260312
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get("code");

if (!code) {
    document.getElementById("content").innerHTML =
        '<p class="error">Kh√¥ng t√¨m th·∫•y m√£ h√≥a ƒë∆°n trong URL.</p>';
} else {

    // üî• Th√™m tham s·ªë ch·ªëng cache + y√™u c·∫ßu kh√¥ng d√πng cache
    const antiCache = Date.now(); // s·ªë mili-gi√¢y hi·ªán t·∫°i
    const jsonUrl = `./invoices/${code}.json?ts=${antiCache}`;

    fetch(jsonUrl, {
        cache: "no-store"
    })
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            // Format s·ªë ti·ªÅn
            const formatMoney = (amount) => {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'ƒë'
                }).format(amount);
            };

            // T·∫°o b·∫£ng s·∫£n ph·∫©m
            let itemsHTML = '';
            if (data.items && data.items.length > 0) {
                itemsHTML = `
                    <h3>Chi ti·∫øt s·∫£n ph·∫©m:</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 10%;">STT</th>
                                <th style="width: 40%;">T√™n thu·ªëc</th>
                                <th style="width: 10%;">ƒêVT</th>
                                <th style="width: 10%;">SL</th>
                                <th style="width: 15%;">ƒê∆°n gi√°</th>
                                <th style="width: 15%;">T·ªïng</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.items.forEach((item, index) => {
                    itemsHTML += `
                        <tr>
                            <td style="text-align: center;">${index + 1}</td>
                            <td>${item.name}</td>
                            <td style="text-align: center;">${item.unit || ''}</td>
                            <td style="text-align: center;">${item.quantity}</td>
                            <td style="text-align: right;">${item.price.toLocaleString('vi-VN')} ƒë</td>
                            <td style="text-align: right;">${item.total.toLocaleString('vi-VN')} ƒë</td>
                        </tr>
                    `;
                });
                
                itemsHTML += `
                        </tbody>
                    </table>
                `;
            }

            document.getElementById("content").innerHTML = `
                <p class="code">M√£ h√≥a ƒë∆°n: ${data.code}</p>
                <div class="info">
                    <p><span class="label">Ng√†y:</span> ${data.date}</p>
                    <p><span class="label">Gi·ªù:</span> ${data.time}</p>
                    <p><span class="label">Thu ng√¢n:</span> ${data.cashier || 'N/A'}</p>
                    <p><span class="label">Kh√°ch h√†ng:</span> ${data.customer || 'Kh√°ch l·∫ª'}</p>
                    <hr>
                    ${itemsHTML}
                    <hr>
                    <p style="font-size: 18px; text-align: right;">
                        <span class="label">T·ªïng c·ªông:</span>
                        <strong>${data.total.toLocaleString('vi-VN')} ƒë</strong>
                    </p>
                </div>
            `;
        })
        .catch(err => {
            console.error('Error:', err);
            document.getElementById("content").innerHTML =
                `<p class="error">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n v·ªõi m√£: <strong>${code}</strong></p>
                <p style="text-align: center; color: #666; font-size: 14px;">Vui l√≤ng ki·ªÉm tra l·∫°i m√£ h√≥a ƒë∆°n.</p>`;
        });
}
</script>
</body>
</html>
