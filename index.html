<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra cứu hóa đơn</title>
<style>
body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 30px auto;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #fafafa;
}
h1 {
    text-align: center;
    color: #0066cc;
}
.code {
    font-size: 20px;
    font-weight: bold;
    margin: 20px 0;
    text-align: center;
}
.info {
    margin-top: 20px;
    padding: 15px;
    background: #fff;
    border-radius: 8px;
    border: 1px solid #ccc;
}
.label {
    font-weight: bold;
}
.loading {
    text-align: center;
    color: #666;
}
.error {
    color: #cc0000;
    text-align: center;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
table th, table td {
    border: 1px solid #ddd;
    padding: 10px 8px;
    text-align: left;
}
table th {
    background-color: #e6f2ff;
    font-weight: bold;
    text-align: center;
}
</style>
</head>
<body>
<h1>Tra cứu hóa đơn nhà thuốc</h1>
<div id="content">
    <p class="loading">Đang tải dữ liệu...</p>
</div>
<script>
// Lấy mã hóa đơn từ URL: ?code=HD202511260312
const urlParams = new URLSearchParams(window.location.search);
const code = urlParams.get("code");

if (!code) {
    document.getElementById("content").innerHTML =
        '<p class="error">Không tìm thấy mã hóa đơn trong URL.</p>';
} else {
    // ✅ Sửa đường dẫn: thêm ./ hoặc dùng đường dẫn tuyệt đối
    const jsonUrl = `./invoices/${code}.json`;
    
    fetch(jsonUrl)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            // Format số tiền
            const formatMoney = (amount) => {
                return new Intl.NumberFormat('vi-VN', {
                    style: 'currency',
                    currency: 'đ'
                }).format(amount);
            };

            // Tạo bảng sản phẩm
            let itemsHTML = '';
            if (data.items && data.items.length > 0) {
                itemsHTML = `
                    <h3>Chi tiết sản phẩm:</h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 10%;">STT</th>
                                <th style="width: 40%;">Tên thuốc</th>
                                <th style="width: 10%;">ĐVT</th>
                                <th style="width: 10%;">SL</th>
                                <th style="width: 15%;">Đơn giá</th>
                                <th style="width: 15%;">Tổng</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.items.forEach((item, index) => {
                    itemsHTML += `
                        <tr>
                            <td style="text-align: center;">${index + 1}</td>
                            <td>${item.name}</td>
                            <td style="text-align: center;">${item.unit || ''}</td>
                            <td style="text-align: center;">${item.quantity}</td>
                            <td style="text-align: right;">${item.price.toLocaleString('vi-VN')} đ</td>
                            <td style="text-align: right;">${item.total.toLocaleString('vi-VN')} đ</td>
                        </tr>
                    `;
                });
                
                itemsHTML += `
                        </tbody>
                    </table>
                `;
            }

            document.getElementById("content").innerHTML = `
                <p class="code">Mã hóa đơn: ${data.code}</p>
                <div class="info">
                    <p><span class="label">Ngày:</span> ${data.date}</p>
                    <p><span class="label">Giờ:</span> ${data.time}</p>
                    <p><span class="label">Thu ngân:</span> ${data.cashier || 'N/A'}</p>
                    <p><span class="label">Khách hàng:</span> ${data.customer || 'Khách lẻ'}</p>
                    <hr>
                    ${itemsHTML}
                    <hr>
                    <p style="font-size: 18px; text-align: right;"><span class="label">Tổng cộng:</span> <strong>${data.total.toLocaleString('vi-VN')} đ</strong></p>
                </div>
            `;
        })
        .catch(err => {
            console.error('Error:', err);
            document.getElementById("content").innerHTML =
                `<p class="error">Không tìm thấy hóa đơn với mã: <strong>${code}</strong></p>
                <p style="text-align: center; color: #666; font-size: 14px;">Vui lòng kiểm tra lại mã hóa đơn.</p>`;
        });
}
</script>
</body>
</html>
